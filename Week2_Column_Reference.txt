WEEK 2 COLUMN REFERENCE
========================
Documents exact column names returned by each Week 2 function.
CRITICAL: Use these exact names - common mistakes noted below each function.

Last Updated: 2026-02-03
Applies to: R/02_player_stats.R, R/03_team_stats.R, R/04_game_analysis.R

================================================================================
PLAYER STATISTICS FUNCTIONS
================================================================================

## get_player_rushing_stats()
-----------------------------
Output columns:
- player_id (chr): Player GSIS ID from nflfastR
- player_name (chr): Full player name
- recent_team (chr): Most recent team (renamed from posteam)
- rushes (int): Number of rushing attempts
- games_played (int): Count of unique game_ids
- rush_yards (int): Total rushing yards
- rush_tds (int): Rushing touchdowns
- rush_first_downs (int): First downs gained on rushing plays
- yards_per_carry (dbl): rush_yards / rushes
- rush_epa (dbl): Sum of EPA on rushing plays
- rush_epa_per_play (dbl): Mean EPA per rushing attempt
- rush_success_rate (dbl): Proportion of rushes with EPA > 0
- explosive_rush_rate (dbl): Proportion of rushes >= 15 yards

NFL Context:
- EPA range: Typically -0.5 to +0.5 per rush on average
- Success rate: League average ~0.45 (45% of rushes succeed)
- Yards per carry: League average ~4.4 YPC
- Explosive plays: Defined as 15+ yards (consider 10+ for alternative)
- Minimum 20 rushes recommended for meaningful YPC analysis

NOT returned (common mistakes):
- 'carries' (use 'rushes')
- 'posteam' (renamed to 'recent_team')
- 'ypc' (use 'yards_per_carry')
- 'attempts' (use 'rushes')

Filters applied:
- play_type == "run"
- !is.na(rusher_player_id)
- !is.na(rusher_player_name)


## get_player_passing_stats()
------------------------------
Output columns:
- player_id (chr): Player GSIS ID
- player_name (chr): Full player name
- recent_team (chr): Most recent team
- attempts (int): All pass attempts (includes sacks, spikes, kneels)
- completions (int): Completed passes
- games_played (int): Count of unique game_ids
- pass_yards (int): Total passing yards
- pass_tds (int): Passing touchdowns
- interceptions (int): Interceptions thrown
- completion_pct (dbl): completions / attempts (range 0.0-1.0)
- yards_per_attempt (dbl): pass_yards / attempts
- pass_epa (dbl): Sum of EPA on passing plays
- pass_epa_per_play (dbl): Mean EPA per pass attempt
- cpoe (dbl): Completion Percentage Over Expected
- air_yards_per_attempt (dbl): Mean air yards per attempt
- sack_rate (dbl): Sacks / attempts
- passer_rating (dbl): NFL passer rating formula (0-158.3 scale)

NFL Context:
- EPA range: Pass plays typically -0.5 to +1.0 per attempt on average
- Success rate: League average ~0.45
- Completion %: League average ~64%
- CPOE: +5% is very accurate, -5% is inaccurate
- Air yards: Measures throw depth, league average ~7-8 yards
- Passer rating: 100+ is very good, <70 is poor (biased toward short passes)
- Minimum 100 attempts recommended for meaningful efficiency metrics

NOT returned (common mistakes):
- 'pass_attempts' (use 'attempts')
- 'comp_pct' (use 'completion_pct')
- 'ypa' (use 'yards_per_attempt')
- 'td_int_ratio' (calculate as pass_tds / interceptions)
- 'qbr' (ESPN's QBR not available in nflfastR)

Filters applied:
- play_type %in% c("pass", "qb_spike", "qb_kneel")
- !is.na(passer_player_id)
- !is.na(passer_player_name)


## get_player_receiving_stats()
--------------------------------
Output columns:
- player_id (chr): Player GSIS ID
- player_name (chr): Full player name
- recent_team (chr): Most recent team
- targets (int): Total targets (passes thrown to player)
- receptions (int): Completed receptions
- games_played (int): Count of unique game_ids
- rec_yards (int): Total receiving yards
- rec_tds (int): Receiving touchdowns
- rec_first_downs (int): First downs gained on receptions
- catch_rate (dbl): receptions / targets (range 0.0-1.0)
- yards_per_reception (dbl): rec_yards / receptions
- yards_per_target (dbl): rec_yards / targets
- rec_epa (dbl): Sum of EPA on targets
- rec_epa_per_target (dbl): Mean EPA per target
- avg_yac (dbl): Mean yards after catch per reception
- avg_air_yards (dbl): Mean air yards per target
- target_share (dbl): Player targets / team total targets (range 0.0-1.0)

NFL Context:
- EPA range: Receiving typically -0.5 to +1.0 per target on average
- Catch rate: League average ~65%, top WRs >70%
- Yards per route run (YPRR): Not in this function (requires route data)
- Target share: >20% is WR1 level, >15% is significant role
- YAC: More receiver skill, air yards more QB decision-making
- Minimum 20 targets recommended for meaningful catch rate

NOT returned (common mistakes):
- 'catches' (use 'receptions')
- 'receiving_yards' (use 'rec_yards')
- 'receiving_tds' (use 'rec_tds')
- 'ypr' (use 'yards_per_reception')
- 'yprr' (yards per route run - not available without route data)

Filters applied:
- play_type == "pass"
- !is.na(receiver_player_id)
- !is.na(receiver_player_name)

================================================================================
TEAM STATISTICS FUNCTIONS
================================================================================

## get_team_offense_stats()
---------------------------
Output columns:
- team (chr): Team abbreviation (renamed from posteam)
- season (chr): Season(s) included (comma-separated if multiple)
- games_played (int): Count of unique game_ids
- total_plays (int): Pass + run attempts
- pass_attempts (int): Passing plays
- rush_attempts (int): Rushing plays
- pass_play_pct (dbl): pass_attempts / total_plays
- total_yards (int): Total yards gained
- yards_per_play (dbl): Mean yards per play
- offensive_epa (dbl): Sum of EPA on all offensive plays
- offensive_epa_per_play (dbl): Mean EPA per play
- success_rate (dbl): Proportion of plays with EPA > 0
- third_down_attempts (int): Plays on 3rd down
- third_down_conversions (int): Successful 3rd down conversions
- third_down_conversion_rate (dbl): Conversions / attempts (NA if no attempts)
- fourth_down_attempts (int): Plays on 4th down
- fourth_down_conversions (int): Successful 4th down conversions
- fourth_down_conversion_rate (dbl): Conversions / attempts (NA if no attempts)
- explosive_play_rate (dbl): Proportion of plays >= 20 yards

NFL Context:
- EPA per play: Top offenses >0.10, league average ~0.00
- Success rate: Top offenses >50%, league average ~45%
- Pass play %: Modern NFL typically 55-65%
- Third down conversion: League average ~40%
- Explosive plays: Defined as 20+ yards
- Minimum 150 plays recommended (~3 games)

NOT returned (common mistakes):
- 'posteam' (renamed to 'team')
- 'off_epa' or 'off_epa_per_play' (use 'offensive_epa_per_play')
- 'rush_epa_per_play' (NOT calculated separately - only offensive_epa_per_play for combined)
- 'pass_epa_per_play' (NOT calculated separately - only offensive_epa_per_play for combined)
- 'third_down_conv_rate' (use 'third_down_conversion_rate')

Filters applied:
- play_type %in% c("pass", "run")
- !is.na(posteam)


## get_team_defense_stats()
---------------------------
Output columns:
- team (chr): Team abbreviation (renamed from defteam)
- season (chr): Season(s) included (comma-separated if multiple)
- games_played (int): Count of unique game_ids
- plays_against (int): Opponent pass + run attempts
- pass_attempts_against (int): Opponent passing plays
- rush_attempts_against (int): Opponent rushing plays
- yards_allowed (int): Total yards allowed
- yards_per_play_allowed (dbl): Mean yards per play allowed
- defensive_epa (dbl): Sum of EPA allowed (lower is better)
- defensive_epa_per_play (dbl): Mean EPA per play allowed (lower is better)
- success_rate_allowed (dbl): Proportion of opponent plays with EPA > 0 (lower is better)
- third_down_attempts_against (int): Opponent 3rd down attempts
- third_down_stops (int): Successful 3rd down stops
- third_down_stop_rate (dbl): Stops / attempts (higher is better, NA if no attempts)
- fourth_down_attempts_against (int): Opponent 4th down attempts
- fourth_down_stops (int): Successful 4th down stops
- fourth_down_stop_rate (dbl): Stops / attempts (higher is better, NA if no attempts)
- sacks (int): Total sacks
- sack_rate (dbl): sacks / pass_attempts_against
- interceptions (int): Interceptions generated
- fumbles_recovered (int): Fumbles recovered
- turnovers_generated (int): interceptions + fumbles_recovered
- turnover_rate (dbl): turnovers_generated / plays_against
- explosive_plays_allowed (int): Plays >= 20 yards allowed
- explosive_play_rate_allowed (dbl): explosive_plays_allowed / plays_against

NFL Context:
- EPA per play: Top defenses <-0.05, league average ~0.00, lower is better
- Success rate allowed: Top defenses <42%, league average ~45%, lower is better
- Sack rate: League average ~6-7%
- Turnover rate: League average ~2-3%
- Third down stop rate: Top defenses >65%, league average ~60%
- Remember: For defense, NEGATIVE EPA is good (preventing points)

NOT returned (common mistakes):
- 'defteam' (renamed to 'team')
- 'def_epa' or 'def_epa_per_play' (use 'defensive_epa_per_play')
- 'points_allowed' (not calculated - use game summary for scoring)
- 'pressures' (not available in basic nflfastR data)

Filters applied:
- play_type %in% c("pass", "run")
- !is.na(defteam)

================================================================================
GAME ANALYSIS FUNCTIONS
================================================================================

## get_game_summary()
---------------------
Output columns:
- game_id (chr): Unique game identifier (e.g., "2024_01_KC_BAL")
- home_team (chr): Home team abbreviation
- away_team (chr): Away team abbreviation
- game_date (date): Date of game
- week (int): Week number
- total_home_score (int): Final home team score
- total_away_score (int): Final away team score
- home_plays (int): Home team offensive plays
- home_epa (dbl): Home team total EPA
- home_success_rate (dbl): Home team success rate
- home_sacks (int): Sacks by home defense
- home_turnovers (int): Turnovers by home offense
- away_plays (int): Away team offensive plays
- away_epa (dbl): Away team total EPA
- away_success_rate (dbl): Away team success rate
- away_sacks (int): Sacks by away defense
- away_turnovers (int): Turnovers by away offense
- total_plays (int): home_plays + away_plays
- score_margin (int): total_home_score - total_away_score
- winner (chr): Home team, away team, or "TIE"

NFL Context:
- Returns NULL if game_id not found
- Single row per game
- EPA and success rate contextualize score (close game vs blowout)
- Turnovers include interceptions and fumbles lost

NOT returned (common mistakes):
- 'home_score' or 'away_score' (use 'total_home_score', 'total_away_score')
- 'final_score' (use total_home_score and total_away_score separately)

Filters applied:
- play_type %in% c("pass", "run") for stats
- Specific game_id


## get_scoring_plays()
----------------------
Output columns:
- game_id (chr): Game identifier
- play_id (int): Play identifier within game
- qtr (int): Quarter (1-4, 5 for OT)
- time_remaining (chr): Time remaining in quarter (MM:SS format)
- down (int): Down (1-4)
- ydstogo (int): Yards to go for first down
- scoring_team (chr): Team that scored
- score_type (chr): "Touchdown", "Field Goal", or "Safety"
- points (int): Points scored (6 for TD, 3 for FG, 2 for safety)
- posteam (chr): Possessing team
- defteam (chr): Defensive team
- score_differential_before (int): Home score - away score before this play
- desc (chr): Play description

NFL Context:
- Sorted by play_id (chronological order)
- TDs show 6 points (extra point/2-pt conversion separate)
- Returns empty tibble if no scoring plays (valid for defensive battles)
- Returns NULL if game_id not found

NOT returned (common mistakes):
- 'time' (use 'time_remaining')
- 'quarter' (use 'qtr')
- 'scoring_play' (all plays returned are scoring plays)

Filters applied:
- !is.na(td_team) | field_goal_result == "made" | safety == 1
- Specific game_id


## get_drive_summary()
----------------------
Output columns:
- game_id (chr): Game identifier
- drive (int): Drive number within game
- posteam (chr): Offensive team
- defteam (chr): Defensive team
- plays (int): Number of plays in drive (from drive_play_count)
- yards_gained (int): Total yards gained on drive (sum of yards_gained)
- yards_penalized (int): Penalty yards (from drive_yards_penalized)
- start_yard_line (int): Starting field position
- end_yard_line (int): Ending field position
- time_of_possession (chr): Drive duration (MM:SS format)
- ended_with_score (int): 1 if drive ended in score, 0 otherwise
- drive_epa (dbl): Sum of EPA across all plays in drive

NFL Context:
- One row per drive
- Field position: 0 = own goal line, 100 = opponent goal line
- ended_with_score includes TDs, FGs, not safeties
- Returns empty tibble if no drives (rare)
- Returns NULL if game_id not found

NOT returned (common mistakes):
- 'drive_number' (use 'drive')
- 'duration' (use 'time_of_possession')
- 'resulted_in_score' (use 'ended_with_score')
- 'drive_result' (use ended_with_score as binary indicator)

Filters applied:
- !is.na(drive)
- Specific game_id

================================================================================
CROSS-FUNCTION NOTES
================================================================================

Common Joining Patterns:

Player stats + Roster data:
  join on: player_id (GSIS ID)
  Note: Use nflreadr::load_rosters() for position, team, status

Team offense + Team defense:
  join on: team
  Note: Creates full team profile (offense + defense)

Player stats early season + Player stats late season:
  join on: player_id
  Note: Enables trend analysis (improving vs declining)

Game summary + Scoring plays:
  game_id present in both
  Note: Scoring plays provide detail, summary provides context

Common Mistakes Across All Functions:

1. Abbreviating column names (off_epa vs offensive_epa_per_play)
2. Using singular when plural expected (rush vs rushes)
3. Using old names after rename (posteam vs team)
4. Assuming columns exist without checking (rush_epa_per_play doesn't exist!)
5. Joining on columns not present in both datasets

Best Practices:

1. Always run names() on function output before writing code
2. Check function source code for exact column names in summarise()
3. Note rename() operations that change final column names
4. Use setdiff() to verify join columns exist in both datasets
5. Document actual column names in code comments

================================================================================
USAGE VERIFICATION EXAMPLE
================================================================================

# CORRECT workflow for using Week 2 functions:

# Step 1: Run function and inspect output
rush_stats <- get_player_rushing_stats(pbp_2024, season = 2024)
names(rush_stats)

# Step 2: Document available columns
# Available: player_id, player_name, recent_team, rushes, games_played,
#            rush_yards, rush_tds, yards_per_carry, etc.

# Step 3: Write code using ONLY verified columns
top_rushers <- rush_stats %>%
  filter(rushes >= 20) %>%                    # ✅ Correct
  select(player_name, rushes, rush_yards) %>%  # ✅ All verified
  arrange(desc(rush_yards)) %>%
  head(10)

# INCORRECT (will cause error):
top_rushers <- rush_stats %>%
  filter(carries >= 20) %>%  # ❌ Column 'carries' doesn't exist!
  select(player_name, ypc)    # ❌ Column 'ypc' doesn't exist!

================================================================================
END OF WEEK 2 COLUMN REFERENCE
================================================================================
